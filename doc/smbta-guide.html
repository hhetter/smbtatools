<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.4.5" />
<title>The SMB Traffic Analyzer Guide</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock {
  padding-left: 2.0em;
  margin-right: 10%;
}
div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock {
  padding-left: 2.0em;
  margin-right: 10%;
}
div.verseblock > div.content {
  white-space: pre;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

@media print {
  div#footer-badges { display: none; }
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock-content {
  white-space: pre;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){generateToc(2)}
/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, October 2006. License: GPL */

function getText(el) {
  var text = "";
  for (var i = el.firstChild; i != null; i = i.nextSibling) {
    if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
      text += i.data;
    else if (i.firstChild != null)
      text += getText(i);
  }
  return text;
}

function TocEntry(el, text, toclevel) {
  this.element = el;
  this.text = text;
  this.toclevel = toclevel;
}

function tocEntries(el, toclevels) {
  var result = new Array;
  var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
  // Function that scans the DOM tree for header elements (the DOM2
  // nodeIterator API would be a better technique but not supported by all
  // browsers).
  var iterate = function (el) {
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
        var mo = re.exec(i.tagName)
        if (mo)
          result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
        iterate(i);
      }
    }
  }
  iterate(el);
  return result;
}

// This function does the work. toclevels = 1..4.
function generateToc(toclevels) {
  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementsByTagName("body")[0], toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "toc" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    document.getElementById("header").removeChild(toc);
}
/*]]>*/
</script>
</head>
<body>
<div id="header">
<h1>The SMB Traffic Analyzer Guide</h1>
<span id="author">Holger Hetterich</span><br />
<span id="email"><tt>&lt;<a href="mailto:ozzy@metal-district.de">ozzy@metal-district.de</a>&gt;</tt></span><br />
<span id="revnumber">version 0.1,</span>
<span id="revdate">May 2010</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>v0.2, Sep 2010</p></div>
</div>
</div>
<h2 id="_what_is_smb_traffic_analyzer">1. What is SMB Traffic Analyzer</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>SMB Traffic Analyzer</strong> (from now on called <strong>SMBTA</strong>) is a software suite utilizing
the <strong>Samba</strong> CIFS server to create statistics about the data traffic on a Samba
network. SMBTA is made out of several components:</p></div>
<div class="ulist"><ul>
<li>
<p>
a module in the <strong>VFS</strong> (Virtual File System) Layer of Samba
</p>
</li>
<li>
<p>
a system daemon program
</p>
</li>
<li>
<p>
two user oriented programs to visualize the statistics
</p>
</li>
</ul></div>
<div class="paragraph"><p>SMBTA is utilizing a <strong>SQL</strong> storage to store data about the traffic caused on a
network. By making this data available via SQL, SMBTA is helpful for many
system administrators.</p></div>
<div class="paragraph"><p>Having knowledge of SQL is not required. The user may also run the client programs
to query the database. These are specialized to the organization of the database,
and are taking away much of the work to translate often needed questions into SQL
statements from the user. They are also running networked, and can be run on a
complete different system where the SQL storage exists.</p></div>
<div class="paragraph"><p>The basic idea and main concept of SMBTA was born on the <strong>SambaXP</strong> conference
in GÃ¶ttingen, Germany, in 2007. At the SNIA conference 2008, I was able to
present a prototype of the idea to the Samba team. The code for the module
got immediately accepted and was introduced with Samba 3.2.0 to Samba users.</p></div>
<div class="paragraph"><p>This document is refering to the version 2.0 of the SMB Traffic Analyzer VFS
module.</p></div>
<div class="paragraph"><p>Please check SMB Traffic Analyzer&#8217;s home page for newer versions of the software or
this document:
<a href="http://holger123.wordpress.com/smb-traffic-analyzer/">http://holger123.wordpress.com/smb-traffic-analyzer/</a></p></div>
<h3 id="_why_using_smb_traffic_analyzer">1.1. Why using SMB Traffic Analyzer</h3><div style="clear:left"></div>
<div class="paragraph"><p>Samba services may run on special hardware, like RAID systems, or other specialized
storage. With SMBTA, the user can create an overview of the network usage
on the network. SMBTA can be used to answer questions like this:</p></div>
<div class="ulist"><ul>
<li>
<p>
Which of my services is the most used one?
</p>
</li>
<li>
<p>
At which time the usage of my service reaches peaks?
</p>
</li>
<li>
<p>
Which service almost never gets used?
</p>
</li>
<li>
<p>
Which users are the highest traffic generators?
</p>
</li>
<li>
<p>
What where the detailed last file activities on a share?
</p>
</li>
<li>
<p>
Which is the top used file by read and write access?
</p>
</li>
</ul></div>
<h3 id="_isn_8217_t_smbta_a_tool_to_control_employees">1.2. Isn&#8217;t SMBTA a tool to control employees?</h3><div style="clear:left"></div>
<div class="paragraph"><p>Yes it can be used like that, but doesn&#8217;t need to be. To expose user names
to a storage is even forbidden in many countries. Therefore, SMBTA allows
for anonymization of any data linked to a person.</p></div>
<div class="paragraph"><p>There are many use cases for SMBTA, like determining and planning hardware for your
services, or analyzing the network before switching to clustered Samba.</p></div>
<h3 id="_the_basic_concept_of_smbta">1.3. The basic concept of SMBTA</h3><div style="clear:left"></div>
<div class="paragraph"><p>The Samba CIFS server features a Virtual File System Layer (VFS), that allows
modules to be linked into the layer, replacing or enhancing the functions
of the VFS. Modules can be linked into and behave completely transparent.</p></div>
<div class="paragraph"><p>SMBTA makes use of this functionality by adding a module to Samba&#8217;s
VFS. In the VFS layer, the module is collecting data from prominent VFS functions like write, read,
close etc.</p></div>
<div class="paragraph"><p>The collected data may be be encrypted, and send over the network to a
receiver program. This daemon program, smbtad, is then building a
SQL storage from the data.</p></div>
<div class="paragraph"><p>Besides of the generated SQL storage, client programs can be used to
query the storage in a specialized way over the network.</p></div>
<h3 id="_where_to_get_smbta">1.4. Where to get SMBTA</h3><div style="clear:left"></div>
<div class="paragraph"><p>The SMBTA VFS module is called vfs_smb_traffic_analyzer.so, and is packaged
with Samba version greater or equal than 3.2.0. However, the current
SMBTA module shipping with Samba is only implementing version 1 of the
SMBTA protocol, and this document is only refering to version 2 of the
protocol. The implementation of vfs_smb_traffic_analyzer.so protocol version 2
can be found in the current master git source tree of Samba. It is expected
to be shipped with Samba 3.6.0.</p></div>
<div class="paragraph"><p>For the openSUSE Linux distribution, SMBTAv2 has been backported to current
Samba releases, from 3.5.0 and newer. You can retrieve the SMBTAv2 VFS module
from the openSUSE BuildService.</p></div>
<div class="paragraph"><p>The other parts of SMBTA, the daemon program smbtad, as well as the client
programs smbtaquery and smbtamonitor are available in source code from
the projects homepage at <a href="http://holger123.wordpress.com/smb-traffic-analyzer/">http://holger123.wordpress.com/smb-traffic-analyzer/</a>.
For the openSUSE Linux distribution, RPM packages are available from the
openSUSE Build Service.</p></div>
<h3 id="_building_smbta_from_the_sources">1.5. Building SMBTA from the sources</h3><div style="clear:left"></div>
<div class="paragraph"><p>The SMBTA tools smbtaquery and smbtamonitor are utilizing cmake as the
primary build tool. To build the tools using cmake, please refer to the
README file delivered with the smbtatools package.</p></div>
</div>
<h2 id="_setting_up_smbta">2. Setting up SMBTA</h2>
<div class="sectionbody">
<h3 id="_activating_the_vfs_module_on_samba_servers">2.1. Activating the VFS module on Samba Servers</h3><div style="clear:left"></div>
<div class="paragraph"><p>In general, the Samba CIFS server is configured via smb.conf, it&#8217;s main
configuration file. A typical service definition would look like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>[ExampleShare]
        path = /space</tt></pre>
</div></div>
<div class="paragraph"><p>Defining the share "ExampleShare" as a CIFS service, refering to the
path /space on the servers storage.</p></div>
<div class="paragraph"><p>By extending the share definition with the commands to load the SMBTA
VFS module, SMBTA logging for this service can be activated:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>[ExampleShare]
        path = /space
        vfs_objects = vfs_smb_traffic_analyzer
        vfs_smb_traffic_analyzer:version = V2
        vfs_smb_traffic_analyzer:host = example.host.ex
        vfs_smb_traffic_analyzer:port = 3490</tt></pre>
</div></div>
<div class="paragraph"><p>By default, SMBTA will use protocol version 1, to not break any existing
installations. Only if the version parameter is given, it will be forced to
use protocol version 2.</p></div>
<div class="paragraph"><p>The host and port parameters define the hostname of the system that will be
used as the target for the VFS modules data to send. It will try to connect
to the port number given with the parameter port.</p></div>
<h3 id="_setting_up_smbtad">2.2. Setting up smbtad</h3><div style="clear:left"></div>
<div class="paragraph"><p>On the target host of the module, the program smbtad is running. It&#8217;s task
is mainly to feed a SQL storage out of the data it receives from the module,
maintain the storage and accept requests from clients.</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbtad -i 3490 -p 3491</tt></pre>
</div></div>
<div class="paragraph"><p>when running as superuser, this command line will listen to VFS module
connections on port 3490, and listen to client connections on port 3491.</p></div>
<div class="paragraph"><p>By default, smbtad creates a database as /var/lib/staddb. If the database
already exists, it will use the existing database.</p></div>
<h3 id="_checking_the_installation">2.3. Checking the installation</h3><div style="clear:left"></div>
<div class="paragraph"><p>When everything is set up, move some data on the shares you have activated
the VFS module on. For example, if you write a file to a share,
you can check the installation by looking into the database
directly, involving the sqlite3 command line interface:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>sqlite3 /var/lib/staddb
$ select * from write;</tt></pre>
</div></div>
<div class="paragraph"><p>You should now see entries of data written by the user you have done
the transfer with. If this works, your SMBTA installation works fine
und you can start pointing more shares to it.</p></div>
<h3 id="_setting_up_encryption">2.4. Setting up Encryption</h3><div style="clear:left"></div>
<div class="paragraph"><p>For security reasons, SMBTA can encrypt it&#8217;s data flow from the module
to the smbtad component. This is optional, data is not encrypted by
default.</p></div>
<div class="paragraph"><p>The encryption method used in SMBTA is 128bit AES. For this encryption,
the user needs to generate a key and make the key known to both the
Samba server where the VFS module is activated and the system smbtad is
running on.</p></div>
<div class="paragraph"><p>To ease the installation of encryption, the Samba server includes a small
utility called smbta-util:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbta -g keyfile</tt></pre>
</div></div>
<div class="paragraph"><p>will generate a key for encryption, activate encryption on the Samba server,
and save the key to a file. The user can then use this file on the smbtad
system and store it in a protected place owned by the superuser.</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbta -u</tt></pre>
</div></div>
<div class="paragraph"><p>will uninstall the key from the Samba server, and deactivate encryption.</p></div>
<div class="paragraph"><p>To setup the key on the smbtad-system, you run smbtad with this command option:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbtad --keyfile=/etc/smbtad/key</tt></pre>
</div></div>
</div>
<h2 id="_using_the_client_programs">3. Using the client programs</h2>
<div class="sectionbody">
<h3 id="_smbtaquery">3.1. smbtaquery</h3><div style="clear:left"></div>
<div class="paragraph"><p>The possibilities to create statistical data out of the data set are
quite wide ranged. Instead of querying the database directly via SQL,
users may use smbtaquery. It is specialized on the setup of the database,
and runs a lot of preconfigured queries to produce statistical and
informational data. smbtaquery is utilizing a simplified language to
operate on the users whish, translates the commands into SQL, and
connects to the smbtad program to run the SQL query. The result is
then printed out.</p></div>
<h4 id="_general_usage">3.1.1. General usage</h4>
<div class="paragraph"><p>Following is an example of a smbtaquery run:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbtaquery -h smbtahost.example.ex -i 3491 -q 'global, usage rw;'</tt></pre>
</div></div>
<div class="paragraph"><p>The command line option -h (or --host) is telling smbtaquery to use
the given host as the system, where smbtad is running on. When running
queries, it will connect to this system with the port number given with
the command line option -i.</p></div>
<div class="paragraph"><p>Finally the command line option -q (or --query) provides the query to
run for the build in interpreter of smbtaquery. More on this follows
in the later chapters.</p></div>
<h4 id="_utilizing_a_configuration_file">3.1.2. Utilizing a configuration file</h4>
<div class="paragraph"><p>The command line options -h (--host) and -i are required every time
smbtaquery should run a query on the database. Therefore, those
parameters can be stored into a configuration file, which will
automatically be loaded and parsed if it is found. The location of
this file is:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$HOME/.smbtatools/query-config</tt></pre>
</div></div>
<div class="paragraph"><p>whereas $HOME is the users home directory.</p></div>
<div class="paragraph"><p>The format of the file is that of a ini file:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>[network]
        hostname = smbtahost.example.ex
        port = 3491</tt></pre>
</div></div>
<h4 id="_the_smbtaquery_interpreter">3.1.3. The smbtaquery interpreter</h4>
<div class="paragraph"><p>To ease the usage of the database, smbtaquery implements a simplified
language to query the database. It is specialized for SMBTA.</p></div>
<h5 id="_syntax">Syntax</h5>
<div class="paragraph"><p>Every command is seperated by a comma, any paraeters to the command are
seperated by space. The last command ends with a semicolon instead of
a comma.</p></div>
<div class="paragraph"><p>Here is an example query:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'global, usage rw;'</tt></pre>
</div></div>
<h5 id="_the_objects">The objects</h5>
<div class="paragraph"><p>Any functions called by smbtaquery are in relation to an object which is
named first. An object can be a file, a share, or a username, or global, which
does not relate to a specific object.</p></div>
<div class="paragraph"><p>For example if you make a query like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share Fritzboxtest, usage rw'</tt></pre>
</div></div>
<div class="paragraph"><p>The calling of the function "usage rw" (as being introduced later in this chapter)
is bound to the share "Fritzboxtest". Any results will be related to this share.</p></div>
<div class="paragraph"><p>The general syntax is first to name the object, and then to run the functions on.
At any time, you can name a new object, and any function run after the new object
definition will be run related to this object.</p></div>
<div class="paragraph"><p>Say "total r" is a function to get the total number of bytes read by an object.
A query could then be:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'user holger, total r;'</tt></pre>
</div></div>
<div class="paragraph"><p>This call would print the total number of bytes read by the user holger.</p></div>
<div class="paragraph"><p>The following query:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share Fritzboxtest, total rw, user holger total w;'</tt></pre>
</div></div>
<div class="paragraph"><p>Would first print out the total number of bytes (written and read) on share
"Fritzboxtest", and then the total number of bytes written by user holger.</p></div>
<div class="paragraph"><p>The following object definitions are currently possible:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share $SHARE' a Samba file service (a share)
'user $USER' a User
'file $FILE' a specific file
'global' Global.</tt></pre>
</div></div>
<div class="paragraph"><p>The "global" parameter is special in the way it treats the following functions.
Functions running on global are not limited by anything, and always work
on the full database. Giving the following query:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'global, total rw;'</tt></pre>
</div></div>
<div class="paragraph"><p>Would print out the full sum of bytes ever transferred (be it read or write).</p></div>
<h5 id="_time_modifiers">Time Modifiers</h5>
<div class="paragraph"><p>Any functions that are called on objects can make use of time modifiers, that allow to specifiy a time range the function shall work on. The supported keywords must be used on objects and are called: <strong>FROM - TO</strong> and <strong>SINCE</strong>.</p></div>
<div class="exampleblock">
<div class="title">Example for FROM-TO:</div>
<div class="exampleblock-content">
<div class="paragraph"><p><em>global from 10-10-2010 to today, total rw;</em></p></div>
</div></div>
<div class="exampleblock">
<div class="title">Example for SINCE:</div>
<div class="exampleblock-content">
<div class="paragraph"><p><em>user holger since yesterday, total rw;</em></p></div>
</div></div>
<div class="paragraph"><p>Allowed keywords for time specification are:
$DATE-$TIME in the fowolling format:
<strong>MM-DD-YYYY HH:MM:SS</strong></p></div>
<div class="paragraph"><p>Also, there are the following keywords making the time specification easier:
<strong>yesterday</strong>, <strong>today</strong> and <strong>now</strong>.</p></div>
<h4 id="_object_identification">3.1.4. Object Identification</h4>
<div class="paragraph"><p>SMBTA will try to identify the objects that given by searching through it&#8217;s
database. For example, the user "holger" could exist more than once. User "holger"
could be coming from two or more domains, each of these listing user "holger"
with a different SID. Therefore SMBTA will look up the known SIDs of user "holger"
and will present a dialog to choose the right user in case more than one user
"holger" exists. As a consequence, shares are checked for domains, and files are
checked for the share and the domain.</p></div>
<h4 id="_the_functions">3.1.5. The functions</h4>
<h5 id="_total">total</h5>
<div class="paragraph"><p>Syntax:
<strong>total [RW] [R] [W]</strong></p></div>
<div class="paragraph"><p>The total function prints out the sum of bytes transferred by an object.</p></div>
<div class="paragraph"><p>"total r" will compute the sum of bytes read.
"total w" will compute the sum of bytes written.
"total rw" will compute the sum of bytes transferred (read and write access).</p></div>
<div class="exampleblock">
<div class="title">Total function example:</div>
<div class="exampleblock-content">
<div class="paragraph"><p>Print out the number of bytes written on the share "Fritzboxtest":</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share Fritzboxtest, total w;'</tt></pre>
</div></div>
</div></div>
<h5 id="_list">list</h5>
<div class="paragraph"><p>Syntax:
<strong>list [users] [files]</strong></p></div>
<div class="paragraph"><p>The list function prints a list of objects related to the given object.</p></div>
<div class="paragraph"><p>"list users" will print out the list of known users working or involved
with the object.
"list files" will print out the list of known files involved with the object.</p></div>
<div class="exampleblock">
<div class="title">List function example:</div>
<div class="exampleblock-content">
<div class="paragraph"><p>Prints out all users who ever touched, read or written to file "README":</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'file README, list users;'</tt></pre>
</div></div>
<div class="paragraph"><p>Print out the list of known files on share "Fritzboxtest":</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share Fritzboxtest, list files;'</tt></pre>
</div></div>
</div></div>
<h5 id="_top">top</h5>
<div class="paragraph"><p>Syntax:
<strong>top [number] [files] [users] [shares] [rw] [r] [w]</strong></p></div>
<div class="paragraph"><p>The top function prints out a number of top files, users, or shares by
read, write or read and write access.</p></div>
<div class="exampleblock">
<div class="title">Top function example:</div>
<div class="exampleblock-content">
<div class="paragraph"><p>Print out the 10 most used files on share "Fritzboxtest" by read access:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share Fritzboxtest, top 10 files r;'</tt></pre>
</div></div>
<div class="paragraph"><p>Print out the 10 most used shares on the Samba network:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'global, top 10 shares rw;'</tt></pre>
</div></div>
</div></div>
<h5 id="_last_activity">last_activity</h5>
<div class="paragraph"><p>Syntax:
<strong>last_activity [number]</strong></p></div>
<div class="paragraph"><p>The last_activity function prints out a list of actions an object has been
involved in.</p></div>
<div class="exampleblock">
<div class="title">last_activity Function example:</div>
<div class="exampleblock-content">
<div class="paragraph"><p>Print out the last 10 actions of user holger:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'user holger, last_activity 10;'</tt></pre>
</div></div>
<div class="paragraph"><p>Print out the last 10 actions where file "README" has been involved in:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'file README, last_activity 10;'</tt></pre>
</div></div>
</div></div>
<h5 id="_usage">usage</h5>
<div class="paragraph"><p>Syntax:
<strong>usage [rw] [r] [w]</strong></p></div>
<div class="paragraph"><p>The usage function sums up the usage or activity of an object by creating
a virtual day, listing 24 hours and showing the data acitvity by percentage.</p></div>
<div class="exampleblock">
<div class="title">usage Function example:</div>
<div class="exampleblock-content">
<div class="paragraph"><p>Print a graph of the total usage of the Samba network:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'global, usage rw;'</tt></pre>
</div></div>
<div class="paragraph"><p>Print a graph of the usage of share "Fritzboxtest" by read-access:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>'share Fritzboxtest, usage r;'</tt></pre>
</div></div>
</div></div>
<h3 id="_smbtamonitor">3.2. smbtamonitor</h3><div style="clear:left"></div>
<div class="paragraph"><p>smbtamonitor allows to view Samba traffic in real-time. The program connects
directly to smbtad via the network. To allow real-time, a special feature in
smbtad has been implemented. Instead of receiving data from the SQL storage,
smbtad filters and sends directly to smbtamonitor when receiving a data package
from a vfs_smb_traffic_analyzer VFS module. The smbtamonitor program is listening
on the smbtad socket for news, and visualizes them in an curses window.</p></div>
<div class="paragraph"><p>This concept allows for interesting options, such as computing the throughput
of an object within smbtad. The queries smbtamonitor is doing are called "monitors"
by the authors. A "monitor" is like a dynamically loaded module in smbtad,
requested by smbtamonitor, and doing some computing on the numbers.</p></div>
<div class="paragraph"><p>For example you can watch the total number of transferred bytes and the throughput
per second of an object by running smbtamonitor.</p></div>
<div class="paragraph"><p>Any smbtamonitor instance is bound to an object ( a user, a file, or a share).
You can run as many smbtamonitor instances as you want against smbtad.</p></div>
<h4 id="_utilizing_a_configuration_file_2">3.2.1. Utilizing a configuration file</h4>
<div class="paragraph"><p>The command line options -h (--host) and -i are required every time
smbtamonitor should run. Therefore, those
parameters can be stored into a configuration file, which will
automatically be loaded and parsed if it is found. The location of
this file is:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$HOME/.smbtatools/monitor-config</tt></pre>
</div></div>
<div class="paragraph"><p>whereas $HOME is the users home directory.</p></div>
<div class="paragraph"><p>The format of the file is that of a ini file:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>[network]
        hostname = smbtahost.example.ex
        port = 3491</tt></pre>
</div></div>
<h4 id="_smbtamonitor_startup">3.2.2. smbtamonitor startup</h4>
<div class="paragraph"><p>To start a monitor, use the same arguments for the host and internet port
to connect to as with smbtaquery:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbtamonitor -h examplehost.de.ex -i 3491 --share "Distribution Space"</tt></pre>
</div></div>
<div class="paragraph"><p>This command will start a real time monitor that will display information about
the share named "Distribution Space". Likewise, it&#8217;s possible to run:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbtamonitor -h examplehost.de.ex -i 3491 --user holger</tt></pre>
</div></div>
<div class="paragraph"><p>which will run a monitor displaying information about the user holger, and:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>smbtamonitor -h examplehost.de.ex -i 3491 --file README</tt></pre>
</div></div>
<div class="paragraph"><p>will run a monitor displaying real time information about the file named
"README".</p></div>
<div class="paragraph"><p>After identification of the given object, like already mentioned in the smbtaquery
chapter, the monitor will initialize the curses library for it&#8217;s display.</p></div>
<div class="paragraph"><p>smbtamonitor runs 80x25 display size fixed at the moment.</p></div>
<div class="paragraph"><p>The smbtamonitor screen is the same for any object given. In the upper half
of the screen the user will be presented the total sum of transferred bytes
by the given object, sorted by read-only requests, write-only and both of them.</p></div>
<div class="paragraph"><p>Then the data throughput per second is displayed, this number should change
quickly when something is transferred involving the given object. The throughput
is also sorted by read-only, write-only and both of them.</p></div>
<div class="paragraph"><p>The lower half of the screen represents a real-time human readable text log
of what happens with the given object. For example copying a simple file on
a share should show that the file was opened, written to, and then closed.</p></div>
</div>
<h2 id="_reporting_problems_bugs_contacting_the_authors">4. Reporting Problems, bugs, contacting the Authors</h2>
<div class="sectionbody">
<div class="paragraph"><p>To find the latest news and versions of SMBTA, check out it&#8217;s homepage:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>http://holger123.wordpress.com/smb-traffic-analyzer/</tt></pre>
</div></div>
<div class="paragraph"><p>If you can reproduce an error situation, do not hestitate to open
a bug on <a href="http://bugzilla.novell.com">http://bugzilla.novell.com</a>, set "Samba" as component,
and begin the Bug subject with [SMBTA].</p></div>
<div class="paragraph"><p>If you have problems that might not be as easy to reproduce, or need help
in doing this, longer stories, or even a word of "Hey SMBTA is cool, thank you!",
please send mail to Holger Hetterich &lt;<a href="mailto:ozzy@metal-district.de">ozzy@metal-district.de</a>&gt;.</p></div>
</div>
<h2 id="_project_outlook_and_version_history">5. Project outlook and version history</h2>
<div class="sectionbody">
<h3 id="_smbtad">5.1. smbtad</h3><div style="clear:left"></div>
<h4 id="_version_0_1">5.1.1. Version 0.1</h4>
<div class="paragraph"><p>Version 0.1 of smbtad is not yet released, and will be released when it&#8217;s done.
The initial version roadmap is to archive the following:
- full documentation (mainly this guide) on smbtad and the smbtatools.
- Binary packages for distributions</p></div>
<h4 id="_version_0_2">5.1.2. Version 0.2</h4>
<div class="ulist"><ul>
<li>
<p>
encryption support smbtad &lt;&#8594; smbtatools
</p>
</li>
</ul></div>
<h3 id="_smbtatools">5.2. smbtatools</h3><div style="clear:left"></div>
<h4 id="_version_0_1_2">5.2.1. Version 0.1</h4>
<div class="paragraph"><p>Version 0.1 of smbtatools is not yet released, and will be released when it&#8217;s done.
The initial version roadmap is to archive the following:
- full documentation (mainly this guide) on the tools.
- binary packages</p></div>
<h4 id="_version_0_2_2">5.2.2. Version 0.2</h4>
<div class="ulist"><ul>
<li>
<p>
encryption support smbtad &lt;&#8594; smbtatools
</p>
</li>
<li>
<p>
XML output support for smbtaquery
</p>
</li>
</ul></div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1<br />
Last updated 2010-09-20 00:29:33 CEST
</div>
</div>
</body>
</html>
